# 技术设计: 维护模式与全员下线

## 技术方案
### 核心技术
- FastAPI 全局中间件
- 配置驱动的维护开关（YAML + 环境变量）
- 前端全局维护守卫（React 入口渲染）

### 实现要点
- 后端新增 maintenance 配置分组（enabled/message/allow_paths）。
- 全局中间件在请求入口判断维护状态：开启时返回 503 维护响应，禁止登录与业务访问。
- 保留 /health（或明确的白名单）用于健康检查与维护状态探测。
- 前端增加 Maintenance 页面：任意路由进入时，如果检测到维护状态则直接渲染维护页面。
- 通过轮换 LOTRO_TOKEN_SECRET 并重启服务实现“全员下线”。

## 架构决策 ADR
### ADR-004: 维护模式采用配置开关 + 全局中间件
**上下文:** 维护窗口需阻止所有写入与登录，且不引入额外管理接口。 
**决策:** 使用配置开关与中间件统一拦截，配合运维重启与 token_secret 轮换。 
**理由:** 实现最小、风险可控、无需新增管理面。 
**替代方案:** 数据库开关 + 管理接口 → 拒绝原因: 暴露面与权限控制成本更高。 
**影响:** 维护切换需要重启服务，需配套运维流程。

## API设计
### GET /health
- **响应:** { status: "ok", maintenance: true/false }

### 维护响应
- **状态码:** 503
- **响应体:** success=false, code="MAINTENANCE", message="系统维护中"

## 安全与性能
- **安全:** 不新增管理接口，避免权限提升风险；维护模式仅由环境配置控制。
- **性能:** 中间件轻量判断，不引入额外数据库查询。

## 测试与部署
- **测试:** 后端中间件覆盖测试（维护开启/关闭、/health 白名单）、前端维护页面渲染测试（或人工验证）。
- **部署:** 修改配置并重启后端；维护期开启时轮换 LOTRO_TOKEN_SECRET 触发全员下线。
