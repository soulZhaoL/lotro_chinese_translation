# 变更提案: 维护模式与全员下线

## 需求背景
文本库版本迭代（如 U46 → U46.1）需要在维护窗口内完成换表、清空锁/认领、迁移变更记录与原子切换。若维护期仍允许访问与编辑，会产生旧 ID 写入、数据错乱与前后端状态不一致等风险，因此系统必须支持“全员下线 + 维护期提示 + 暂停登录 + 全局拦截”。

## 产品分析

### 目标用户与场景
- **用户群体:** 翻译成员、管理员、运维
- **使用场景:** 数据库换表维护窗口、紧急回滚、重大版本发布
- **核心痛点:** 在线编辑与换表冲突、用户持续提交导致数据错乱、维护期缺少统一提示

### 价值主张与成功指标
- **价值主张:** 维护期统一拦截与提示，避免写入冲突，提供明确反馈
- **成功指标:**
  - 维护期开启后所有 API 请求统一返回维护提示
  - 登录与写操作不可用，旧 token 在维护期内立即失效
  - 前端在任何页面/入口均显示维护页面

### 人文关怀
维护提示应清晰说明原因与预计恢复方式，避免用户误操作或产生焦虑，同时不暴露敏感运维细节。

## 变更内容
1. 增加维护模式配置与全局拦截机制。
2. 维护期暂停登录，并支持全员下线流程（轮换 token_secret + 重启）。
3. 前端新增维护页面与全局守卫，任何场景均展示维护页面。
4. 维护提示统一标准响应与文案。

## 影响范围
- **模块:** 用户与权限、文本任务与翻译、前端应用
- **文件:** config/lotro.yaml、server/app.py、server/config/loader.py、server/response.py、server/routes/health.py、web/src/App.tsx、web/src/api.ts、web/src/pages/Maintenance.tsx
- **API:** 全量接口、/auth/login、/health
- **数据:** 配置与环境变量

## 核心场景

### 需求: 维护模式全局拦截
**模块:** 后端全局中间件、前端入口
维护期开启后应阻止所有业务访问。

#### 场景: 维护期开启
维护模式开启且服务重启后：
- 所有 API 返回维护响应（统一状态码与文案）
- 前端任意入口均显示维护页面

### 需求: 全员下线与暂停登录
**模块:** 认证与权限
维护期开启时登录不可用，历史 token 立即失效。

#### 场景: 切换维护窗口
运维轮换 token_secret 并重启后端：
- 旧 token 立即失效
- /auth/login 返回维护提示

### 需求: 维护解除与恢复访问
**模块:** 前端与后端
维护结束后系统应恢复正常访问。

#### 场景: 维护结束
关闭维护模式并重启服务：
- API 恢复正常响应
- 登录与业务页面正常可用

## 风险评估
- **风险:** 维护开关误操作导致长时间不可用
- **缓解:** 明确运维流程、健康检查白名单、维护提示文案与回滚步骤
