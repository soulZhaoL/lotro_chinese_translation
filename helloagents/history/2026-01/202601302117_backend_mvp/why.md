# 变更提案: 后端优先 MVP（补齐 API/权限/锁定/校验 + 最小前端）

## 需求背景
当前仅完成数据库初始迁移脚本，API、权限、锁定与校验均停留在规划阶段；同时文档与实际 SQL 存在不一致（text_locks 的 released_at 字段仅在 SQL 中存在，data.md 缺失）。需要先补齐后端能力与文档一致性，再构建最小前端以验证主流程。

## 变更内容
1. 补齐后端基础能力：认证/权限、主文本列表与详情、认领、锁定/释放、变更历史、词典、文本校验
2. 数据与文档一致性修复：补齐 released_at 字段说明并确立迁移策略
3. 最小前端：文本列表、翻译页与锁定提示、词典管理基础页

## 影响范围
- **模块:** 用户与权限、文本任务与翻译、词典管理、文本校验
- **文件:** server/*、server/migrations/*、web/*、helloagents/wiki/*
- **API:** /auth/login、/texts、/claims、/locks、/changes、/dictionary、/validate
- **数据:** text_locks（released_at 字段）

## 核心场景

### 需求: 账号登录与权限
**模块:** 用户与权限
用户使用账号登录并获取角色权限。

#### 场景: 账号登录
输入用户名/密码，服务端验证后返回用户信息与权限集合。
- 登录成功返回会话/令牌与角色权限

### 需求: 主文本列表与筛选
**模块:** 文本任务与翻译
支持按 fid/part/状态/关键字/分页进行列表筛选。

#### 场景: 组合筛选
用户输入筛选条件，返回分页列表。
- 列表包含锁定状态/认领信息

### 需求: 认领与锁定
**模块:** 文本任务与翻译
支持认领与进入翻译页时的锁定/释放。

#### 场景: 进入翻译页锁定
用户打开翻译页即申请锁定，成功后允许编辑，离开或超时释放。
- 同一文本仅允许一个活跃锁

### 需求: 翻译与变更历史
**模块:** 文本任务与翻译
保存译文时写入变更历史。

#### 场景: 保存译文
用户保存译文，系统写入 text_changes 并更新 text_main。
- 可查询变更历史

### 需求: 词典管理
**模块:** 词典管理
提供词典 CRUD 与启用状态。

#### 场景: 翻译时提示
前端可获取词典条目并展示。
- 可筛选与分页

### 需求: 文本格式校验
**模块:** 文本校验
提供校验接口用于保存前检查。

#### 场景: 保存前校验
提交译文前调用校验接口，返回错误提示。
- 校验失败阻止保存

## 风险评估
- **风险:** 修改已执行的初始迁移导致环境不一致
- **缓解:** 优先新增独立迁移（例如 002_add_released_at.sql）；仅在确认数据库未初始化时才修改 001_init.sql
